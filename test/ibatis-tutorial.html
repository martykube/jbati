<html>
	<head>
		<title>jBati test - iBbatis tutorial</title>
		<!--
			An initial set of test cases to demonstrate CRUD operations.
			Modeled on the iBatis tutorial.
		-->
		<script src="../jbati.js" runat="server"></script>
		<script src="ibatis-tutorial.js" runat="server"></script>
		<script runat="server">
		
			//
			// test utils
			//

  		function oncallback() {
				Jaxer.Log.info('oncallback');
				if(typeof jBati == 'undefined') {
					Jaxer.Log.info('oncallback: loading ../jbati.js');
					Jaxer.load('../jbati.js');
				}
				if(typeof example == 'undefined') {
					Jaxer.Log.info('oncallback: loading ibatis-tutorial.js');
					Jaxer.load('ibatis-tutorial.js');
				}
			}

			function assertEquals(actual, expected, msg) {
				if(actual == expected) return true;
				throw new Error('actual: ' + actual + ', did not match expected: ' +
					expected + ', ' + msg);
			}
			
			function assertEqualsDateToDate(actual, expected, msg) {
				if(actual.getUTCFullYear() == expected.getUTCFullYear()
					&& actual.getUTCMonth() == expected.getUTCMonth()
					&& actual.getUTCDay() == expected.getUTCDay()){
						 return true;
				} else {
					throw new Error('actual: ' + actual.toUTCString() + ', did not match expected: ' +
						expected.toUTCString() + ', ' + msg);
				}
			}

			function initTable() {
				Jaxer.DB.execute("drop table if exists test_person");
				Jaxer.DB.execute( 
					"create table if not exists test_person ( " +
						"per_id 			integer, " +
						"per_first_name 	varchar(20), " +
						"per_last_name 	varchar(20), " +
						"per_birth_date 	datetime, " +
						"per_weight_kg 	decimal(5,2), " +
						"per_height_m		decimal(5,2), " +
						"constraint person_pk primary key(per_id))"
				);
			}
	
			function getTestDate() {
				var d = new Date();
				d.setUTCMilliseconds(0);
				d.setUTCSeconds(0); 
				d.setUTCMinutes(0); 
				d.setUTCHours(0); 
				d.setUTCDate(20);
				d.setUTCMonth(10); 
				d.setUTCFullYear(1975); 
				return d;
			}


			//
			// test cases
			//
			
			//
			// Create
			//
			function testCreatePerson_server() {
				Jaxer.Log.info('testCreatePerson_server');
				initTable();
				var person = new examples.domain.Person();
				person.id = 102;
				person.firstName = 'Glenn';
				person.lastName = 'Harpner'
				person.birthDate = getTestDate();
				person.weightInKilograms =  67;
				person.heightInMeters = 1.92;

				jBati.SqlMapClient.insert('insertPerson', person);
				
				var resultSet = Jaxer.DB.execute(						
						'SELECT ' +
						'PER_ID 			as id,' +
						'PER_FIRST_NAME 	as firstName,' +
						'PER_LAST_NAME 	as lastName,' +
						'PER_BIRTH_DATE 	as birthDate,' +
						'PER_WEIGHT_KG 	as weightInKilograms,' +
						'PER_HEIGHT_M		as heightInMeters' +
						'	FROM TEST_PERSON' +
						'	WHERE PER_ID = 102'
				);
				var actual = resultSet.rows[0];
				assertEquals(actual.id, 102, 'person.id did not match');
				assertEquals(actual.firstName, 'Glenn', 'firstName did not match');
				assertEquals(actual.lastName, 'Harpner', 'lastName did not match');
				assertEqualsDateToDate(actual.birthDate, getTestDate(), 'birthDate did not match');
				assertEquals(actual.weightInKilograms, 67, 'weightInKilograms did not match');
				assertEquals(actual.heightInMeters, 1.92, 'heightInMeters did not match');
			}
			testCreatePerson_server.proxy = true;

			//
			// Read
			//
			function testReadPerson_server() {
				Jaxer.Log.info('testReadPerson_server');
				initTable();
				Jaxer.DB.execute( 
					"INSERT INTO test_person (per_id, per_first_name, per_last_name, per_birth_date, per_weight_kg, per_height_m) " +
					"VALUES (2, 'John', 'Doe', '1975-11-20', 80.2, 1.5);"
				);
				
				var person = jBati.SqlMapClient.queryForObject('getPerson', 2);

				assertEquals(person.constructor, examples.domain.Person, 'should be a Person object');
				assertEquals(person.id, 2, 'person.id did not match');
				assertEquals(person.firstName, 'John', 'person.firstName did not match');
				assertEquals(person.lastName, 'Doe', 'person.lastName did not match');
				assertEqualsDateToDate(person.birthDate, getTestDate(), 'person.birthDate did not match');
				assertEquals(person.weightInKilograms, 80.2, 'person.weightInKilograms did not match');
				assertEquals(person.heightInMeters, 1.5, 'person.heightInMeters did not match');
			}
			testReadPerson_server.proxy = true;
			
			//
			// Update
			//
			function testUpdatePerson_server() {
				Jaxer.Log.info('testUpdatePerson_server');
				initTable();
				Jaxer.DB.execute( 
					"INSERT INTO test_person (per_id, per_first_name, per_last_name, per_birth_date, per_weight_kg, per_height_m) " +
					"VALUES (47, 'John', 'Doe', '1998-10-01', 80.2, 1.5);"
				);
				var person = new examples.domain.Person();
				person.id = 47;
				person.firstName = 'Bob';
				person.lastName = 'Harpner'
				person.birthDate = getTestDate();
				person.weightInKilograms =  67;
				person.heightInMeters = 1.92;

				jBati.SqlMapClient.update('updatePerson', person);
				
				var resultSet = Jaxer.DB.execute(						
						'SELECT ' +
						'PER_ID 			as id,' +
						'PER_FIRST_NAME 	as firstName,' +
						'PER_LAST_NAME 	as lastName,' +
						'PER_BIRTH_DATE 	as birthDate,' +
						'PER_WEIGHT_KG 	as weightInKilograms,' +
						'PER_HEIGHT_M		as heightInMeters' +
						'	FROM TEST_PERSON' +
						'	WHERE PER_ID = 47'
				);
				var actual = resultSet.rows[0];
				assertEquals(actual.id, 47, 'id did not match');
				assertEquals(actual.firstName, 'Bob', 'firstName did not match');
				assertEquals(actual.lastName, 'Harpner', 'lastName did not match');
				assertEqualsDateToDate(actual.birthDate, getTestDate(), 'birthDate did not match');
				assertEquals(actual.weightInKilograms, 67, 'weightInKilograms did not match');
				assertEquals(actual.heightInMeters, 1.92, 'heightInMeters did not match');
			}
			testUpdatePerson_server.proxy = true;

			//
			// Delete
			//
			function testDeletePerson_server() {
				Jaxer.Log.info('testDeletePerson_server');
				initTable();
				Jaxer.DB.execute( 
					"INSERT INTO test_person (per_id, per_first_name, per_last_name, per_birth_date, per_weight_kg, per_height_m) " +
					"VALUES (57, 'John', 'Doe', '1998-10-01', 80.2, 1.5);"
				);

				jBati.SqlMapClient.delete('deletePerson', parseInt('57'));
				
				var resultSet = Jaxer.DB.execute(						
						'SELECT ' +
						'PER_ID 			as id,' +
						'PER_FIRST_NAME 	as firstName,' +
						'PER_LAST_NAME 	as lastName,' +
						'PER_BIRTH_DATE 	as birthDate,' +
						'PER_WEIGHT_KG 	as weightInKilograms,' +
						'PER_HEIGHT_M		as heightInMeters' +
						'	FROM TEST_PERSON' +
						'	WHERE PER_ID = 57'
				);
				assertEquals(resultSet.rows.length, 0, 'should be 0 rows');
			}
			testDeletePerson_server.proxy = true;

		</script>
		
		<script runat='client'>
		
			function setTestStatus(statusDivName, status, error) {
				var msg = status;
				if(error) msg += '<br/>' + error;
				document.getElementById(statusDivName).innerHTML = msg;
			}
			
			function runTest(serverCall, statusDiv) {
				try {
					setTestStatus(statusDiv, 'running');
					serverCall();
					setTestStatus(statusDiv, 'pass');
				} catch (e) {
					setTestStatus(statusDiv, 'fail', e.message);
				}
			}
			
			function testCreatePerson() {
				runTest(testCreatePerson_server, 'create-person-status');
			}

			function testReadPerson() {
				runTest(testReadPerson_server, 'read-person-status');
			}
			
			function testUpdatePerson() {
				runTest(testUpdatePerson_server, 'update-person-status');
			}

			function testDeletePerson() {
				runTest(testDeletePerson_server, 'delete-person-status');
			}

			function runAllTest() {
				testCreatePerson();
				testReadPerson();
				testUpdatePerson();
				testDeletePerson();
			}
		</script>
	</head>
	<body onload="runAllTest()">
		<table style="width: auto;" border="2">
			<tr style="font-weight: bold">
				<td>Try Again</td>
				<td>Test</td>
				<td>Status</td>
			</tr>
			<tr>
				<td><button onclick="testCreatePerson();">Run Again</button></td>
				<td>Create Person</td>
				<td id="create-person-status">&nbsp;</td>
			</tr>
			<tr>
				<td><button onclick="testReadPerson();">Run Again</button></td>
				<td>Read Person</td>
				<td id="read-person-status">&nbsp;</td>
			</tr>
			<tr>
				<td><button onclick="testUpdatePerson();">Run Again</button></td>
				<td>Update Person</td>
				<td id="update-person-status">&nbsp;</td>
			</tr>
			<tr>
				<td><button onclick="testDeletePerson();">Run Again</button></td>
				<td>Delete Person</td>
				<td id="delete-person-status">&nbsp;</td>
			</tr>
		</table>
	</body>
<html>